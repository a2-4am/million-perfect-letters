;license:MIT
;(c) 2020 by 4am
;
!cpu 6502
!to "build/MILLION.SYSTEM",plain
*=$2000

column = $FC
row = $FD

         !source "src/constants.a"              ; no code
         !source "src/macros.a"                 ; no code
         !source "src/million.init.a"           ; one-time initialization code
         !source "src/hw.vbl.init.a"

FirstMover
!pseudopc $4000 {
Start
         jsr   TitlePage
         ; C set if title sequence ended prematurely (i.e. main menu requires full redraw)
-        jsr   MainMenu
         bcc   +
         jmp   Quit
+        sta   gLevelID
         jsr   MaybeLoadLevelsFromDisk          ; A = level ID from 'select level' page
         bcc   +
         jmp   $FF59 ; TODO
+        ldx   gLevelID
         lda   kLevelLeftMargins, x
         sta   GlobalLeftMargin
         lda   kLevelWidths, x
         jsr   InitPuzzleStorage
         lda   #0
         sta   gPuzzleID
         ;jsr   FindNextUnsolvedPuzzle ; TODO

         jsr   ParseOnePuzzle

         lda   #0
         sta   selected_logical_column
         jsr   RedrawPuzzle
         jsr   AnimatePuzzleIntoPlace
         jsr   DrawColumnSelectionIndicator
         jsr   PlayEventLoop
         sec
         bcs   -                     ; always branches

         !source "src/puzzle.a"
         !source "src/hw.vbl.a"
         !source "src/hw.storage.a"
         !source "src/glue.mli.a"
         !source "src/ui.title.a"
         !source "src/ui.main.menu.a"
         !source "src/ui.play.a"
         !source "src/ui.common.a"
         !source "src/ui.font.courier.double.prime.a"
         !source "src/ui.font.courier.double.prime.data.a"
         !source "src/ui.font.heavy.silk.a"
         !source "src/ui.font.heavy.silk.data.a"
}
