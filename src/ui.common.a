;license:MIT
;(c) 2020 by 4am
;
; common graphics functions
;

GlobalLeftMargin
         ; TODO other values for smaller puzzles
         ; $0A for 7-letter puzzles
         !byte $0A

Home
; in:    none, but assumes text screen 1 is clear (this is done at program startup)
; out:   hi-res page 1 cleared and displayed
         bit   PAGE1
         bit   FULLGFX
         bit   HIRES
         bit   TEXTMODE
         ldx   #$20
         stx   @erase+2
         ldy   #$00
         tya
@erase   sta   $2000,y
         iny
         bne   @erase
         inc   @erase+2
         dex
         bne   @erase
         bit   GFXMODE
         rts

WaitForKeyWithTimeout
; in:    A = timeout length (like standard $FCA8 wait routine)
; out:   A clobbered
;        X/Y preserved
         sec
@wait1   pha
@wait2   sbc   #1
         bne   @wait2
         pla
         bit   $C000
         bmi   @exit
         sbc   #1
         bne   @wait1
@exit    rts

ScrollDown
; in:    Y = logical column to scroll
; out:   X/Y preserved
         stx   @x+1
         sty   @y+1
         ldx   #$16
         jsr   LogicalColumnToPhysicalColumn
         jsr   InitScrollStorage
         jsr   WaitForVBL
         jsr   GENSCROLLDOWN
         jsr   UnwaitForVBL
@x       ldx   #$FD                  ; SMC
@y       ldy   #$FD                  ; SMC
         rts

ScrollUp
; in:    Y = logical column to scroll
; out:   X/Y preserved
         stx   @x+1
         sty   @y+1
         ldx   #$16
         jsr   LogicalColumnToPhysicalColumn
         jsr   InitScrollStorage
         jsr   WaitForVBL
         jsr   GENSCROLLUP
         jsr   UnwaitForVBL
@x       ldx   #$FD                  ; SMC
@y       ldy   #$FD                  ; SMC
         rts

InitScrollStorage
         lda   #$00
         sta   $FC
         sta   $FD
         sta   $FE
         sta   $FF
         rts

LogicalColumnToPhysicalColumn
; in:    Y contains logical column number
; out:   Y contains physical byte offset to use against an HGR base address
;        A clobbered
;        X preserved
         lda   GlobalLeftMargin
         clc
         bcc   +
-        adc   #$03
+        dey
         bpl   -
         tay
         rts

;------------------------------------------------------------------------------
; SoftBell
;
; in:    none
; out:   all registers and flags clobbered
;------------------------------------------------------------------------------
SoftBell
         ldx   #32
-        lda   #2
         jsr   ROM_WAIT
         bit   SPEAKER
         lda   #33
         jsr   ROM_WAIT
         bit   SPEAKER
         dex
         bne   -
         rts
